<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Schapp</title>
  <meta name="Generator" content="GaugeIt" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="MobileOptimized" content="width">
  <meta name="HandheldFriendly" content="true">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta http-equiv="cleartype" content="on">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <link rel="shortcut icon" href="static/favicon.ico">
  <link rel="apple-touch-icon" href="static/apple-touch-icon.png">
  <link rel="stylesheet" href="http://code.jquery.com/mobile/1.0rc1/jquery.mobile-1.0rc1.min.css" />
  <script src="http://code.jquery.com/jquery-1.6.4.min.js"></script>
  <script src="static/js/json2.js"></script>
  <script src="static/js/underscore.js"></script>
  <script src="static/js/backbone.js"></script>
  <script>
    $(document).bind("mobileinit", function () {
      $.extend($.mobile, { ajaxEnabled: false, hashListeningEnabled: false, pushStateEnabled: false });
    });
  </script>
  <script src="http://code.jquery.com/mobile/1.0rc1/jquery.mobile-1.0rc1.min.js"></script>
  <script>
    $(function () {
      window.ShoppingItem = Backbone.Model.extend({
        defaults: function () {
          return { name: 'New Item', price: 0.0, shop: "New Shop", quantity: 1, id: Math.random(), done: false };
        }
        , validate: function (params) {
          if (params.price && isNaN(params.price)) return "Price needs to be a valid number";
          if (params.quantity && isNaN(params.quantity)) return "Quantity needs to be avalid number";
        }
        , sync: function (method, model, options) { options.success(); }
      });
      window.ShoppingItemList = Backbone.Collection.extend({ model: ShoppingItem });
      window.ShoppingList = Backbone.Model.extend({
        initialize: function () {
          var model = this;
          this._items = new ShoppingItemList;
          this._items.bind('change', this.saveChanges, this);
        }
        , saveChanges: function () { this.save() }
        , toJSON: function () {
          var attrs = _.clone(this.attributes);
          if (this._items.length) attrs['item'] = this._items.toJSON();
          return attrs;
        }
        , parseItems: function (model, resp) {
          model._items.reset(_.map(resp.item, function (e) { return new ShoppingItem(e) }));
          return resp;
        }
        , url: function () {
          var l = this.get('link');
          return l ? '/api/lists/' + l : '/api/lists';
        }
        , isNew: function () {
          return this.get('link') == null;
        }
        , defaults: function () {
          return {
            name: 'New List'
            , link: null
          };
        }
      });

      window.ShoppingItemView = Backbone.View.extend({
        tagName: "div"
        , template: _.template($('#item-template').html())
        , initialize: function () { }
        , toggleDone: function (e) {
          this.model.set({ "done": !this.model.get("done") });
        }
        , render: function () {
          $(this.el).html(this.template(this.model.toJSON()));
          this.$("input[type=checkbox]").bind("change", _.bind(this.toggleDone, this));
          return this;
        }
      });

      window.ShoppingListView = Backbone.View.extend({
        el: $('#shoppinglist')
        , events: {
          "click .list-name-text": "edit"
          , "click .list-name-input-confirm": "close"
          , "keypress .list-item-input": "addOnEnter"
          , "click .list-item-input-confirm": "addOnClick"
        }
        , initialize: function () {
          this.nameinput = this.$('.list-name-input');
          this.addinput = this.$('.list-item-input');
          this.nameinput.bind('blur', _.bind(this.close, this));
          this.model._items.bind('add', this.addOne, this);
          this.model._items.bind('reset', this.addAll, this);
        }
        , render: function () {
          this.$(".emailSender").prop('href', "#send/" + this.model.get('link'));
          var text = this.model.get('name');
          this.$('.list-name-text').text(text);
          this.nameinput.val(text);
          this.addinput.val('');
          return this.el;
        }
        , edit: function () {
          $(this.el).addClass("editing");
        }
        , close: function () {
          this.model.save({ name: this.nameinput.val() });
          $(this.el).removeClass("editing");
        }
        , updateOnEnter: function (e) {
          if (e.keyCode == 13) this.close();
        }
        , addOne: function (item) {
          var view = new ShoppingItemView({ model: item });
          $("#shoppinglist-items").append(view.render().el).trigger("create"); //jQueryMobile create, not backbone
        }
        , addAll: function () {
          this.model._items.each(this.addOne);
        }
        , addOnClick: function (e) { return this.addOn(e, function (e) { return false; }); }
        , addOnEnter: function (e) { return this.addOn(e, function (e) { return e.keyCode != 13; }); }
        , addOn: function (e, filter) {
          var name = this.addinput.val(), view = this;
          if (!name || filter(e)) return;
          this.model._items.create(
            { name: name, price: this.$('.list-price-input').val(), quantity: this.$('.list-qty-input').val() }
            , {
              error: function (model, error) {
                alert(error);
              }
              , success: function () {
                view.model.save();
                view.$('.item-input-field').each(function (i, elem) { elem = $(elem); elem.val(elem.attr("_default")); });
              }
            }
        );
        }
        , tearDown: function () {
          this.model._items.unbind();
          this.model.unbind();
          this.nameinput.unbind();
          this.el.unbind();
          delete this.model._items;
          $("#shoppinglist-items").empty();
        }
      });

      window.MainAppView = Backbone.View.extend({
        el: $("#home")
        , events: {
          "keypress #new-slist-name": "createOnEnter"
          , "click .button": "createOnClick"
        }
        , initialize: function () {
          this.input = $("#new-slist-name");
        }
        , render: function () {
          if (this.shoppinglist_view.model.hasChanged('link')) {
            listRouter.navigate("list/" + this.shoppinglist_view.model.get('link'));
          }
          this.shoppinglist_view.render();
          $.mobile.changePage($("#shoppinglist"), { transition: "slideup", changeHash: false, allowSamePageTransition: false, reverse: false, showLoadMsg: true });
        }
        , reset: function () {
          if (this.shoppinglist_view) {
            this.shoppinglist_view.tearDown();
            delete this.shoppinglist_view;
          }
          $(this.el).removeClass("hidden");
          $.mobile.changePage($("#home"), { transition: "slideup", changeHash: false, allowSamePageTransition: true, reverse: true, showLoadMsg: false });
          this.input.val('');
        }
        , createOnClick: function (e) { return this.createOn(e, function (e) { return false; }); }
        , createOnEnter: function (e) { return this.createOn(e, function (e) { return e.keyCode != 13; }); }
        , createOn: function (e, filter) {
          var text = this.input.val();
          if (!text || filter(e)) return;
          this.shoppinglist_view = new ShoppingListView({ model: new ShoppingList({ name: text }) });
          this.shoppinglist_view.model.bind('change', this.render, this);
          this.shoppinglist_view.model.save();
        }
        , openList: function (link) {
          this.shoppinglist_view = new ShoppingListView({ model: new ShoppingList({ 'link': link }) });
          this.shoppinglist_view.model.bind('change', this.render, this);
          this.shoppinglist_view.model.fetch({ success: this.shoppinglist_view.model.parseItems });
        }
        , sendEmail: function (link) {
          $.mobile.changePage($("#sendEmail"), { transition: "slideup", changeHash: false, allowSamePageTransition: true, reverse: true, showLoadMsg: false });
        }
      });
      window.App = new MainAppView();

      ListRouter = Backbone.Router.extend({
        routes: { "home": "resetView"
                  , "send/:link": "sendEmail"
                  , "list/:link": "openList"
                  , "*other": "resetView"
        }
        , openList: function (link) {
          App.openList(link);
        }
        , resetView: function () {
          App.reset();
        }
        , sendEmail: function (link) {
          App.sendEmail(link);
        }
      });
      listRouter = new ListRouter;
      Backbone.history.start();
    });
  </script>
  <style>
      .list-remove {padding: 1em; background-color:black;color:white;float:right}
      .editing .editor
      , .display {display:block;}
      .hidden
      , .editing .display
      , .editor {display:none;}
  </style>
</head>
<body>
  <div data-role="page" id="home" class="hidden">
    <div data-role="header" data-position="inline">
      <h1>
        Create your shopping list!</h1>
      <a class="ui-btn-right" href="#list/I" rel="external">sample list</a>
    </div>
    <div id="approot" data-role="content">
      <div id="app-create-controls">
        <div class="fieldset">
          <input type="text" name="list-name" placeholder="list name" id="new-slist-name"
            tabindex="1">
        </div>
        <div class="fieldset">
          <div class="button active">
            <input type="button" name="start" id="create-list" value="New List" tabindex="3"></div>
        </div>
      </div>
    </div>
  </div>

  <div data-role="page" id="shoppinglist" data-title="Edit Shopping List">
    <div data-role="header">
      <a href="#home" rel="external">back</a>
      <h1>
        Edit Shopping List!</h1>
      <a href="#" data-icon="check" rel="external" class="emailSender">send by email</a>
    </div>
    <div id="slist" data-role="content">
      <h4>List:</h4>
      <div class="display">
        <h2 class="list-name-text"><%= name %></h2>
      </div>
      <div class="editor">
        <input class="list-name-input" type="text" value="" />
        <input class="list-name-input-confirm" type="button" value="save" />
      </div>
      <br/>
      <br/>
      <hr />
			<div data-role="fieldcontain">
			 	<fieldset data-role="controlgroup">
					<legend>Items:</legend>
          <ul id="shoppinglist-items"></ul>
        </fieldset>
      </div>
      <div data-role="fieldcontain">
          <label for="list-item-input">New Item:</label>
          <input class="list-item-input item-input-field" id="list-item-input" type="text" value="" _default="" />
      </div>	
      <div data-role="fieldcontain">
          <label for="list-qty-input">Quantity:</label>
          <input class="list-qty-input item-input-field" id="list-qty-input" type="number" value="1" _default="1"/>
      </div>	
      <div data-role="fieldcontain">
          <label for="list-price-input">Price:</label>
          <input class="list-price-input item-input-field" id="list-price-input" type="number" value="0.0" _default="0.0" />
      </div>	
      <input class="list-item-input-confirm" type="button" value="add" />      
    </div>
  </div>

    <div data-role="page" id="sendEmail" data-title="Send Shopping List">
      <div data-role="header">
        <a href="javascript:history.back()" rel="external">back</a>
        <h1>Send Shopping List!</h1>
      </div>
      <div data-role="content">
        <div data-role="fieldcontain">
            <label for="list-qty-input">Send to:</label>
            <input class="email-input email-input-field" id="email" type="email" value="" _default=""/>
        </div>	
        <input class="email-input-confirm" type="button" value="send" />
      </div>
    </div>





  <script type="text/template" id="item-template">
      <div>
        <input type="checkbox" name="checkbox-<%= id %>" id="checkbox-<%= id %>" class="custom toggleDone" <% if(done){print("checked");} %>/>
				<label for="checkbox-<%= id %>">
          <%= quantity %> x <%= name %>
          <% if (price!=0) { %>
             for <% print(parseFloat(price).toFixed(2)); %>
          <% } %>
        </label>
      </div>
  </script>


</body>
</html>
