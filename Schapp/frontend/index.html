<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Schapp</title>
    <meta name="Generator" content="GaugeIt" />
    <meta name="viewport" content="width=device-width, target-densityDpi=160dpi, initial-scale=1">
    <meta name="MobileOptimized" content="width">
    <meta name="HandheldFriendly" content="true">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta http-equiv="cleartype" content="on">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link rel="stylesheet" href="static/css/styles.css" type="text/css" media="screen" />
    <link rel="shortcut icon" href="static/favicon.ico">
    <link rel="apple-touch-icon" href="static/apple-touch-icon.png">
    <script src="static/js/json2.js"></script>
    <script src="http://code.jquery.com/jquery-1.6.4.min.js"></script>
    <script src="static/js/underscore.js"></script>
    <script src="static/js/backbone.js"></script>
    
    
    <script>
      $(function(){
        window.SItem = Backbone.Model.extend({
          defaults: function() {
            return {
              name : 'New Item'
            };
          }
        });
        window.SItemList = Backbone.Collection.extend({model: SItem});

        window.SList = Backbone.Model.extend({
          initialize: function(){
            this.items = new SItemList;
            this.items.url = '/api/items';
          }
          ,url : function(){
            var l = this.get('link');
            return l?'/api/lists/'+l:'/api/lists';
          }
          ,isNew : function() {
            return this.get('link') == null;
          }
          ,defaults: function() {
            return {
              name : 'New List'
              ,link : null
            };
          }
        });
         
        
        window.SListList = Backbone.Collection.extend({model: SList});
        window.SLists = new SListList;
        
        window.SListView = Backbone.View.extend({
          tagName:  "li",className: "list"
          ,template: _.template($('#list-template').html())
          ,events: {
            "click .list-text": "edit"
          }
          ,initialize: function() {
            this.model.bind('change', this.render, this);
            this.model.bind('destroy', this.remove, this);
          }
          ,render: function() {
            $(this.el).html(this.template(this.model.toJSON()));
            this.setText();
            return this;
          }
          ,setText: function() {
            var text = this.model.get('name');
            this.$('.list-text').text(text);
            this.input = this.$('.list-input');
            this.input.bind('blur', _.bind(this.close, this)).val(text);
          }
          ,edit: function() {
            $(this.el).addClass("editing");
          }
          ,close: function() {
            this.model.save({name: this.input.val()});
            $(this.el).removeClass("editing");
          }
          ,updateOnEnter: function(e) {
            if (e.keyCode == 13) this.close();
          }
        });
          
          
          
        window.AppView = Backbone.View.extend({
          el: $("#approot")
          ,events: {
            "keypress #new-slist-name":  "createOnEnter",
            "click .button":  "createOnClick",
          }
          ,initialize: function() {
            this.input  = this.$("#new-slist-name");
            SLists.bind('add', this.addOne, this);
          }
          ,addOne: function(slist) {
            var slist = new SListView({model: slist}), _t = this;
            $("#app-create-controls").fadeOut(200, function(){_t.$("#slists-list").append(slist.render().el);});
          }
          ,display:function(slist){
            $("#app-create-controls").fadeIn();
          }
          ,createOnEnter: function(e) {
            var text = this.input.val();
            if (!text || e.keyCode != 13) return;
            SLists.create({name: text});
            this.input.val('');
          }
          ,createOnClick: function(e) {
            var text = this.input.val();
            if (!text) return;
            SLists.create({name: text});
            this.input.val('');
          }
        });
        window.App = new AppView;

        ListRouter = Backbone.Router.extend({
          routes :{"/":"resetView"
                  ,"/:link" : "openList"
                  ,"*other" : "resetView"
          }
          ,openList : function(link){
            SLists.add(new SList({link:link}).fetch());
          }
          ,resetView : function(){
            _.invoke(SLists.models, "remove");
          }
        });

        listRouter = new ListRouter;
        Backbone.history.start();
      });
    </script>
    
    <style>
      .list-remove {padding: 1em; background-color:black;color:white;float:right}
      .list-back {float:right;cursor:pointer}
      .display {display:block;}
      .edit {display:none;}
      .editing .display {display:none;}
      .editing .edit {display:block;}
    </style>
    
    
    
    
    
    
    
  </head>
  <body class="container">
    <header class="row">
      <div class="twelvecol">
        <h1>Create your shopping list!</h1>
        <a href="#/I">sample list</a>
      </div>
    </header>
    
    
    
    <div id="approot" class="row">
      <div class="twelvecol" id="slists">
          <ul id="slists-list"></ul>
      </div>
      <div id="app-create-controls">
          <div class="fourcol fieldset">
            <input type="text" name="list-name" placeholder="list name" style="width:100%" id="new-slist-name" tabindex="1">
          </div>
          <div class="fourcol">
              <div class="button active"><input type="button" name="start" value="New List" tabindex="3"></div>
          </div>
      </div>
    </div>
    
    
    <script type="text/template" id="list-template">
        <div class="display">
          <div class="list-text"><%= link %> - <%= name %></div>
        </div>
        <div class="edit">
          <input class="list-input" type="text" value="" />
        </div>
    </script>
  </body>
</html>